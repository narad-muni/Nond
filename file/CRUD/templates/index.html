<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CRUD Application</title>

        <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-icons.css') }}" />
        <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>

    </head>
    <body class="container-fluid mt-5">
        <div class="card">
            <div
                class="card-header d-flex flex-row justify-content-between text-primary"
            >
                <div class="card-title mt-2">
                    <i class="bi bi-person"></i>
                    Students
                </div>

                <button id="create-btn" onclick="createModal()" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i>
                    Add Students
                </button>
            </div>
            <div class="card-body">
                <table class="table table-striped text-center" id="table">
                    <thead>
                        <tr>
                            <th scope="col">Roll No</th>
                            <th scope="col">Name</th>
                            <th scope="col">Department</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <script>

            let id = 0;

            async function createModal(){
                let createModal = new bootstrap.Modal(document.getElementById("createModal"));

                createModal.show();
            }

            async function createAction(){
                let name = document.getElementById("create-name").value;
                let department = document.getElementById("create-department").value;

                let body = {
                    name: name,
                    department: department
                }

                let resp = await fetch("/create",{
                    method: "POST",
                    headers: new Headers({
                        "Content-Type": "application/json"
                    }),
                    body: JSON.stringify(body)
                });

                let data = await resp.json();

                if(data?.status == "success"){
                
                    if(data?.message){
                        showSuccessModal(data.message);
                    }
                }else{
                    showErrorModal(data?.message || "Some error occured");
                }

                await readAll();
            }
            
            async function editModal(e){
                let editModal = new bootstrap.Modal(document.getElementById("editModal"));

                id = e.target.getAttribute("data-id");

                let resp = await fetch("/read/"+id);
                let data = await resp.json()

                let name = document.getElementById("edit-name");
                let department = document.getElementById("edit-department");

                if(data?.status == "success"){

                    data = data.data;

                    name.value = data[1];
                    department.value = data[2];

                    if(data?.message){
                        showSuccessModal(data.message);
                    }
                }else{
                    showErrorModal(data?.message || "Some error occured");
                }
                
                id = e.target.getAttribute("data-id");

                editModal.show();
            }
    
            async function editAction(){
                let name = document.getElementById("edit-name").value;
                let department = document.getElementById("edit-department").value;

                let body = {
                    roll_no: id,
                    name: name,
                    department: department
                }

                let resp = await fetch("/update",{
                    method: "PUT",
                    headers: new Headers({
                        "Content-Type": "application/json"
                    }),
                    body: JSON.stringify(body)
                });

                let data = await resp.json();

                if(data?.status == "success"){
                
                    if(data?.message){
                        showSuccessModal(data.message);
                    }
                }else{
                    showErrorModal(data?.message || "Some error occured");
                }

                await readAll();
            }


            async function deleteModal(e){
                let deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
                
                id = e.target.getAttribute("data-id");

                deleteModal.show();
            }

            async function deleteAction(){

                let body = {
                    roll_no: id
                }

                let resp = await fetch("/delete",{
                    method: "DELETE",
                    headers: new Headers({
                        "Content-Type": "application/json"
                    }),
                    body: JSON.stringify(body)
                });

                let data = await resp.json();

                if(data?.status == "success"){
                
                    if(data?.message){
                        showSuccessModal(data.message);
                    }
                }else{
                    showErrorModal(data?.message || "Some error occured");
                }

                await readAll();
            }

            function showSuccessModal(message){
                let successModal = new bootstrap.Modal(document.getElementById("successModal"));
                
                document.getElementById("success-message").innerHTML = message;

                successModal.show();
            }

            function showErrorModal(message){
                let errorModal = new bootstrap.Modal(document.getElementById("errorModal"));

                document.getElementById("error-message").innerHTML = message;

                errorModal.show();
            }

            async function readAll(){
                try{
                    let table = document.getElementById("table");
                    let tbody = table.querySelector("tbody");
                    tbody.innerHTML = "";

                    let resp = await fetch("/read");
                    let data = await resp.json();

                    if(data?.status == "success"){

                        data.data.forEach(student => {
                            let tr = document.createElement("tr");

                            let roll_no = document.createElement("td");
                            let name = document.createElement("td");
                            let department = document.createElement("td");
                            let actions = document.createElement("td");

                            let edit_btn = document.createElement("button");
                            let delete_btn = document.createElement("button");

                            roll_no.classList.add("p-3");
                            name.classList.add("p-3");
                            department.classList.add("p-3");

                            edit_btn.classList.add("btn","btn-success","edit-btn","m-1");
                            delete_btn.classList.add("btn","btn-danger","delete-btn","m-1");

                            edit_btn.setAttribute("data-id",student[0]);
                            delete_btn.setAttribute("data-id",student[0]);

                            edit_btn.addEventListener("click",editModal);
                            delete_btn.addEventListener("click",deleteModal);

                            delete_btn.innerHTML = "<i class=\"bi bi-trash\"></i>Delete";
                            edit_btn.innerHTML = "<i class=\"bi bi-pencil-square\"></i>Edit";

                            roll_no.innerText = student[0];
                            name.innerText = student[1];
                            department.innerText = student[2];

                            roll_no.setAttribute("scope","row");
                            actions.appendChild(edit_btn);
                            actions.appendChild(delete_btn);
                            
                            tr.appendChild(roll_no);
                            tr.appendChild(name);
                            tr.appendChild(department);
                            tr.appendChild(actions);

                            tbody.appendChild(tr);

                        });

                        if(data.data.length <= 0){
                            tbody.innerHTML = "<tr><td class=\"bg-light h5\" colspan=\"4\">No Students found</td></tr>";
                        }

                        if(data?.message){
                            showSuccessModal(data.message);
                        }
                    }else{
                        showErrorModal(data?.message || "Some error occured");
                    }

                }catch(e){
                    console.log(e);
                    showErrorModal("Some error occured");
                }
            }

            window.onload = async () => await readAll();

        </script>

        <!-- Modal -->

        <!-- Success Modal-->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel">Success</h5>
                    <button type="button" class="btn-close bg-primary" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="success-message">
                    Hello World
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Error Modal-->
        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close bg-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="error-message">
                    Hello World
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Delete Modal-->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel">Delete Student</h5>
                        <button type="button" class="btn-close bg-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this student
                    </div>
                    <div class="modal-footer">
                        <button id="delete" onclick="deleteAction()" type="button" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Modal-->
        <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="createModalLabel">Add Student</h5>
                    <button type="button" class="btn-close bg-primary" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="form-group mb-3">
                        <label>Name</label>
                        <input id="create-name" type="text" class="form-control" placeholder="Name">
                    </div>

                    <div class="form-group mb-3">
                        <label>Department</label>
                        <input id="create-department" type="text" class="form-control" placeholder="Department">
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="delete" onclick="createAction()" type="button" class="btn btn-primary" data-bs-dismiss="modal">Create</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal-->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="editModalLabel">Edit Student</h5>
                    <button type="button" class="btn-close bg-success" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="form-group mb-3">
                        <label>Name</label>
                        <input id="edit-name" type="text" class="form-control" placeholder="Name">
                    </div>

                    <div class="form-group mb-3">
                        <label>Department</label>
                        <input id="edit-department" type="text" class="form-control" placeholder="Department">
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="delete" onclick="editAction()" type="button" class="btn btn-success" data-bs-dismiss="modal">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

    </body>
</html>
